<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Gestione Ordini</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',system-ui,sans-serif;background:#1f2937;min-height:100vh;color:#f9fafb}
    .login-screen{position:fixed;inset:0;background:#1f2937;display:flex;align-items:center;justify-content:center;z-index:1000}
    .login-box{background:#374151;padding:3rem;border-radius:20px;text-align:center;width:100%;max-width:400px;margin:1rem}
    .login-logo{font-size:4rem;margin-bottom:1rem}.login-box h2{margin-bottom:.5rem}.login-box>p{color:#9ca3af;margin-bottom:2rem}
    .login-box input{width:100%;padding:1rem;border:2px solid #4b5563;border-radius:10px;background:#1f2937;color:#fff;font-size:1rem;margin-bottom:1rem;text-align:center}
    .login-box input:focus{outline:none;border-color:#7c3aed}
    .login-box button{width:100%;padding:1rem;background:linear-gradient(135deg,#7c3aed,#4f46e5);color:#fff;border:none;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer}
    .login-error{color:#ef4444;margin-top:1rem;min-height:1.5rem}
    header{background:#111827;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #374151;flex-wrap:wrap;gap:1rem}
    .logo{font-size:1.5rem;font-weight:900;color:#a78bfa}.logo span{color:#6b7280;font-weight:400;font-size:1rem}
    .header-actions{display:flex;align-items:center;gap:1rem}.header-actions a{color:#9ca3af;text-decoration:none}
    .btn-logout{background:#ef4444;color:#fff;border:none;padding:.5rem 1rem;border-radius:8px;cursor:pointer;font-weight:600}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;padding:2rem;max-width:1400px;margin:0 auto}
    .stat-card{background:#374151;padding:1.5rem;border-radius:12px}.stat-card h3{color:#9ca3af;font-size:.875rem;text-transform:uppercase}
    .stat-card .value{font-size:2rem;font-weight:700;margin-top:.5rem}
    .stat-card.pending .value{color:#fbbf24}.stat-card.paid .value{color:#34d399}.stat-card.shipped .value{color:#60a5fa}.stat-card.revenue .value{color:#a78bfa}
    .filters{padding:0 2rem;max-width:1400px;margin:0 auto;display:flex;gap:.5rem;flex-wrap:wrap}
    .filter-btn{padding:.5rem 1.5rem;border:none;border-radius:20px;cursor:pointer;font-weight:500;background:#374151;color:#f9fafb}.filter-btn:hover{background:#4b5563}.filter-btn.active{background:#7c3aed}
    .orders{padding:2rem;max-width:1400px;margin:0 auto}
    .order-card{background:#374151;border-radius:12px;margin-bottom:1rem;overflow:hidden}
    .order-header{padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;border-bottom:1px solid #4b5563}
    .order-id{font-weight:700;font-size:1.1rem}.order-date{color:#9ca3af;font-size:.875rem}
    .order-status{padding:.25rem .75rem;border-radius:20px;font-size:.75rem;font-weight:600;text-transform:uppercase}
    .status-pending{background:#fbbf24;color:#1f2937}.status-paid{background:#34d399;color:#1f2937}.status-shipped{background:#60a5fa;color:#1f2937}.status-delivered{background:#a78bfa;color:#1f2937}
    .order-body{padding:1.5rem;display:grid;grid-template-columns:1fr 1fr;gap:2rem}
    .order-section h4{color:#9ca3af;font-size:.75rem;text-transform:uppercase;margin-bottom:.5rem}.order-section p{margin:.25rem 0}
    .order-items{margin-top:1rem}.order-item{display:flex;justify-content:space-between;align-items:center;padding:.75rem;background:#4b5563;border-radius:8px;margin-bottom:.5rem}
    .item-check{display:flex;align-items:center;gap:.75rem}.item-check input[type="checkbox"]{width:20px;height:20px;cursor:pointer;accent-color:#7c3aed}
    .item-shipped{opacity:.5;text-decoration:line-through}.order-total{font-size:1.25rem;font-weight:700;color:#a78bfa;margin-top:1rem}
    .order-actions{padding:1rem 1.5rem;border-top:1px solid #4b5563;display:flex;gap:.75rem;flex-wrap:wrap}
    .btn{padding:.5rem 1rem;border:none;border-radius:8px;cursor:pointer;font-weight:600}.btn-paid{background:#34d399;color:#1f2937}.btn-shipped{background:#60a5fa;color:#1f2937}.btn-delivered{background:#a78bfa;color:#1f2937}.btn:hover{opacity:.8}.btn:disabled{opacity:.3;cursor:not-allowed}
    .empty{text-align:center;padding:4rem;color:#6b7280}.loading{text-align:center;padding:4rem}
    .payment-warning{background:#fbbf24;color:#1f2937;padding:.5rem 1rem;border-radius:8px;font-size:.875rem;margin:0 1.5rem 1rem}
    @media(max-width:768px){.order-body{grid-template-columns:1fr}.stats{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <div id="login-screen" class="login-screen">
    <div class="login-box">
      <div class="login-logo">üîê</div>
      <h2>Area Riservata</h2>
      <p>Inserisci la password</p>
      <form onsubmit="checkPassword(event)">
        <input type="password" id="admin-password" placeholder="Password" autofocus>
        <button type="submit">Accedi ‚Üí</button>
      </form>
      <p id="login-error" class="login-error"></p>
    </div>
  </div>

  <div id="admin-panel" style="display:none">
    <header>
      <div class="logo">TOP PHONE <span>/ Admin</span></div>
      <div class="header-actions"><a href="index.html">‚Üê Sito</a><button class="btn-logout" onclick="logout()">Esci</button></div>
    </header>
    <div class="stats">
      <div class="stat-card pending"><h3>In Attesa</h3><div class="value" id="stat-pending">0</div></div>
      <div class="stat-card paid"><h3>Da Spedire</h3><div class="value" id="stat-paid">0</div></div>
      <div class="stat-card shipped"><h3>Spediti</h3><div class="value" id="stat-shipped">0</div></div>
      <div class="stat-card revenue"><h3>Incasso</h3><div class="value" id="stat-revenue">‚Ç¨0</div></div>
    </div>
    <div class="filters">
      <button class="filter-btn active" onclick="filterOrders('all',this)">Tutti</button>
      <button class="filter-btn" onclick="filterOrders('pending',this)">‚è≥ Attesa</button>
      <button class="filter-btn" onclick="filterOrders('paid',this)">‚úÖ Pagati</button>
      <button class="filter-btn" onclick="filterOrders('shipped',this)">üì¶ Spediti</button>
      <button class="filter-btn" onclick="filterOrders('delivered',this)">üè† Consegnati</button>
    </div>
    <div class="orders" id="orders"><div class="loading">‚è≥ Caricamento...</div></div>
  </div>

  <script>
    // ============================================
    // ‚öôÔ∏è CONFIGURAZIONE
    // ============================================
    const SUPABASE_URL = 'https://hrjokojbvbmcftmjxihv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhyam9rb2pidmJtY2Z0bWp4aWh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NjY0NzYsImV4cCI6MjA3OTM0MjQ3Nn0.Lk2_VLJbsfQrtDbGgFq9mCNKKdkdyTdCOhktsYIO1Vg';
    const ADMIN_PASSWORD = 'admin123'; // ‚Üê CAMBIA QUESTA PASSWORD!
    // ============================================

    let orders = [], orderItems = {}, currentFilter = 'all';

    function checkSession() { if (sessionStorage.getItem('adminLoggedIn') === 'true') showAdminPanel(); }
    function checkPassword(e) {
      e.preventDefault();
      if (document.getElementById('admin-password').value === ADMIN_PASSWORD) { sessionStorage.setItem('adminLoggedIn', 'true'); showAdminPanel(); }
      else { document.getElementById('login-error').textContent = '‚ùå Password errata'; document.getElementById('admin-password').value = ''; }
    }
    function showAdminPanel() { document.getElementById('login-screen').style.display = 'none'; document.getElementById('admin-panel').style.display = 'block'; loadOrders(); }
    function logout() { sessionStorage.removeItem('adminLoggedIn'); location.reload(); }

    async function loadOrders() {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/orders?select=*&order=created_at.desc`, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
        orders = await res.json();
        for (const o of orders) {
          const r = await fetch(`${SUPABASE_URL}/rest/v1/order_items?select=*,products(name,price)&order_id=eq.${o.id}`, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
          orderItems[o.id] = await r.json();
        }
        updateStats(); renderOrders();
      } catch (e) { document.getElementById('orders').innerHTML = '<div class="empty">‚ùå Errore</div>'; }
    }

    function updateStats() {
      document.getElementById('stat-pending').textContent = orders.filter(o => o.status === 'pending').length;
      document.getElementById('stat-paid').textContent = orders.filter(o => o.status === 'paid').length;
      document.getElementById('stat-shipped').textContent = orders.filter(o => o.status === 'shipped' || o.status === 'delivered').length;
      document.getElementById('stat-revenue').textContent = `‚Ç¨${orders.filter(o => o.status !== 'pending').reduce((s, o) => s + parseFloat(o.total || 0), 0).toFixed(2)}`;
    }

    function filterOrders(s, btn) { currentFilter = s; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderOrders(); }

    function renderOrders() {
      const f = currentFilter === 'all' ? orders : orders.filter(o => o.status === currentFilter);
      if (!f.length) { document.getElementById('orders').innerHTML = '<div class="empty">üì≠ Nessun ordine</div>'; return; }
      document.getElementById('orders').innerHTML = f.map(o => {
        const items = orderItems[o.id] || [];
        const date = new Date(o.created_at).toLocaleDateString('it-IT', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        const labels = {pending:'‚è≥ Attesa',paid:'‚úÖ Pagato',shipped:'üì¶ Spedito',delivered:'üè† Consegnato'};
        return `<div class="order-card">
          <div class="order-header"><div><span class="order-id">#${o.id}</span><span class="order-date"> - ${date}</span></div><span class="order-status status-${o.status}">${labels[o.status]||o.status}</span></div>
          ${o.status==='pending'?'<div class="payment-warning">‚ö†Ô∏è NON SPEDIRE - Pagamento non confermato</div>':''}
          <div class="order-body">
            <div class="order-section"><h4>üë§ Cliente</h4><p><strong>${o.customer_name||'N/D'}</strong></p><p>${o.customer_email||''}</p><p>${o.customer_phone||''}</p><h4 style="margin-top:1rem">üìç Indirizzo</h4><p>${o.customer_address||'N/D'}</p>${o.notes?`<p><em>${o.notes}</em></p>`:''}</div>
            <div class="order-section"><h4>üì¶ Prodotti</h4><div class="order-items">${items.map(i=>`<div class="order-item ${i.shipped?'item-shipped':''}"><label class="item-check"><input type="checkbox" ${i.shipped?'checked':''} onchange="toggleItem(${o.id},${i.id},this.checked)" ${o.status==='pending'?'disabled':''}><span>${i.products?.name||'Prodotto'} √ó ${i.quantity}</span></label><span>‚Ç¨${(parseFloat(i.price)*i.quantity).toFixed(2)}</span></div>`).join('')}</div><div class="order-total">Totale: ‚Ç¨${parseFloat(o.total).toFixed(2)}</div></div>
          </div>
          <div class="order-actions">
            <button class="btn btn-paid" onclick="updateStatus(${o.id},'paid')" ${o.status!=='pending'?'disabled':''}>‚úÖ Pagato</button>
            <button class="btn btn-shipped" onclick="updateStatus(${o.id},'shipped')" ${o.status!=='paid'?'disabled':''}>üì¶ Spedito</button>
            <button class="btn btn-delivered" onclick="updateStatus(${o.id},'delivered')" ${o.status!=='shipped'?'disabled':''}>üè† Consegnato</button>
          </div>
        </div>`;
      }).join('');
    }

    async function updateStatus(id, s) {
      if (!confirm(`Cambiare stato ordine #${id}?`)) return;
      
      const order = orders.find(o => o.id === id);
      
      await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${id}`, { 
        method: 'PATCH', 
        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' }, 
        body: JSON.stringify({ status: s }) 
      });
      
      // Invia email se stato = spedito
      if (s === 'shipped' && order?.customer_email) {
        await sendShippedEmail(order);
      }
      
      order.status = s; 
      updateStats(); 
      renderOrders();
    }

    async function sendShippedEmail(order) {
      // Email semplice usando EmailJS (gratuito)
      // Oppure mostra messaggio per invio manuale
      const email = order.customer_email;
      const subject = `Il tuo ordine #${order.id} √® stato spedito! üì¶`;
      const body = `Ciao ${order.customer_name},%0A%0AIl tuo ordine #${order.id} √® stato spedito!%0A%0AIndirizzo di consegna:%0A${order.customer_address}%0A%0ATotale: ‚Ç¨${parseFloat(order.total).toFixed(2)}%0A%0AGrazie per il tuo acquisto!%0A%0AIl team Top Phone`;
      
      // Apre client email con messaggio precompilato
      window.open(`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${body}`, '_blank');
      
      alert(`üìß Email pronta per ${email}!\nClicca "Invia" nel tuo client email.`);
    }

    async function toggleItem(oid, iid, shipped) {
      await fetch(`${SUPABASE_URL}/rest/v1/order_items?id=eq.${iid}`, { method: 'PATCH', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ shipped }) });
      const i = orderItems[oid]?.find(x => x.id === iid); if (i) i.shipped = shipped; renderOrders();
    }

    checkSession();
  </script>
</body>
</html>