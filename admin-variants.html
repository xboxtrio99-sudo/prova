<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Top Phone - Pannello Admin</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Segoe UI',system-ui,sans-serif;background:#1f2937;min-height:100vh;color:#f9fafb}
    .login-screen{position:fixed;inset:0;background:#1f2937;display:flex;align-items:center;justify-content:center;z-index:1000}
    .login-box{background:#374151;padding:3rem;border-radius:20px;text-align:center;width:100%;max-width:400px;margin:1rem}
    .login-logo{font-size:4rem;margin-bottom:1rem}.login-box h2{margin-bottom:.5rem}.login-box>p{color:#9ca3af;margin-bottom:2rem}
    .login-box input{width:100%;padding:1rem;border:2px solid #4b5563;border-radius:10px;background:#1f2937;color:#fff;font-size:1rem;margin-bottom:1rem;text-align:center}
    .login-box input:focus{outline:none;border-color:#7c3aed}
    .login-box button{width:100%;padding:1rem;background:linear-gradient(135deg,#7c3aed,#4f46e5);color:#fff;border:none;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer}
    .login-error{color:#ef4444;margin-top:1rem;min-height:1.5rem}
    header{background:#111827;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #374151;flex-wrap:wrap;gap:1rem}
    .logo{font-size:1.5rem;font-weight:900;color:#a78bfa}.logo span{color:#6b7280;font-weight:400;font-size:1rem}
    .header-actions{display:flex;align-items:center;gap:1rem}.header-actions a{color:#9ca3af;text-decoration:none}
    .btn-logout{background:#ef4444;color:#fff;border:none;padding:.5rem 1rem;border-radius:8px;cursor:pointer;font-weight:600}
    .tabs{display:flex;gap:0;padding:0 2rem;max-width:1400px;margin:2rem auto 0;border-bottom:2px solid #374151}
    .tab-btn{padding:1rem 2rem;border:none;background:transparent;color:#9ca3af;cursor:pointer;font-weight:600;font-size:1rem;border-bottom:3px solid transparent;transition:all .2s}
    .tab-btn:hover{color:#f9fafb}.tab-btn.active{color:#a78bfa;border-bottom-color:#7c3aed}
    .tab-content{display:none}.tab-content.active{display:block}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;padding:2rem;max-width:1400px;margin:0 auto}
    .stat-card{background:#374151;padding:1.5rem;border-radius:12px}.stat-card h3{color:#9ca3af;font-size:.875rem;text-transform:uppercase}
    .stat-card .value{font-size:2rem;font-weight:700;margin-top:.5rem}
    .stat-card.pending .value{color:#fbbf24}.stat-card.paid .value{color:#34d399}.stat-card.shipped .value{color:#60a5fa}.stat-card.revenue .value{color:#a78bfa}
    .filters{padding:0 2rem;max-width:1400px;margin:0 auto;display:flex;gap:.5rem;flex-wrap:wrap}
    .filter-btn{padding:.5rem 1.5rem;border:none;border-radius:20px;cursor:pointer;font-weight:500;background:#374151;color:#f9fafb}.filter-btn:hover{background:#4b5563}.filter-btn.active{background:#7c3aed}
    .orders{padding:2rem;max-width:1400px;margin:0 auto}
    .order-card{background:#374151;border-radius:12px;margin-bottom:1rem;overflow:hidden}
    .order-header{padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;border-bottom:1px solid #4b5563}
    .order-id{font-weight:700;font-size:1.1rem}.order-date{color:#9ca3af;font-size:.875rem}
    .order-status{padding:.25rem .75rem;border-radius:20px;font-size:.75rem;font-weight:600;text-transform:uppercase}
    .status-pending{background:#fbbf24;color:#1f2937}.status-paid{background:#34d399;color:#1f2937}.status-shipped{background:#60a5fa;color:#1f2937}.status-delivered{background:#a78bfa;color:#1f2937}
    .order-body{padding:1.5rem;display:grid;grid-template-columns:1fr 1fr;gap:2rem}
    .order-section h4{color:#9ca3af;font-size:.75rem;text-transform:uppercase;margin-bottom:.5rem}.order-section p{margin:.25rem 0}
    .order-items{margin-top:1rem}.order-item{display:flex;justify-content:space-between;align-items:center;padding:.75rem;background:#4b5563;border-radius:8px;margin-bottom:.5rem}
    .item-check{display:flex;align-items:center;gap:.75rem}.item-check input[type="checkbox"]{width:20px;height:20px;cursor:pointer;accent-color:#7c3aed}
    .item-shipped{opacity:.5;text-decoration:line-through}.order-total{font-size:1.25rem;font-weight:700;color:#a78bfa;margin-top:1rem}
    .order-actions{padding:1rem 1.5rem;border-top:1px solid #4b5563;display:flex;gap:.75rem;flex-wrap:wrap}
    .btn{padding:.5rem 1rem;border:none;border-radius:8px;cursor:pointer;font-weight:600}.btn-paid{background:#34d399;color:#1f2937}.btn-shipped{background:#60a5fa;color:#1f2937}.btn-delivered{background:#a78bfa;color:#1f2937}.btn:hover{opacity:.8}.btn:disabled{opacity:.3;cursor:not-allowed}
    .empty{text-align:center;padding:4rem;color:#6b7280}.loading{text-align:center;padding:4rem}
    .payment-warning{background:#fbbf24;color:#1f2937;padding:.5rem 1rem;border-radius:8px;font-size:.875rem;margin:0 1.5rem 1rem}
    .products-header{padding:2rem;max-width:1400px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
    .btn-add{background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;padding:.75rem 1.5rem;border-radius:10px;cursor:pointer;font-weight:600;font-size:1rem}
    .btn-add:hover{opacity:.9}
    .products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.5rem;padding:0 2rem 2rem;max-width:1400px;margin:0 auto}
    .product-card{background:#374151;border-radius:12px;overflow:hidden;transition:transform .2s}.product-card:hover{transform:translateY(-4px)}
    .product-img{height:180px;background:#4b5563;display:flex;align-items:center;justify-content:center;font-size:4rem;background-size:cover;background-position:center}
    .product-body{padding:1.25rem}
    .product-cat{font-size:.75rem;color:#a78bfa;text-transform:uppercase;font-weight:600}
    .product-name{font-weight:700;font-size:1.1rem;margin:.5rem 0;color:#f9fafb}
    .product-price{font-size:1.3rem;font-weight:700;color:#34d399;margin:.5rem 0}
    .product-stock{font-size:.875rem;color:#9ca3af;margin:.25rem 0}
    .product-actions{display:flex;gap:.5rem;margin-top:1rem}
    .btn-edit{background:#60a5fa;color:#fff;border:none;padding:.5rem 1rem;border-radius:8px;cursor:pointer;font-weight:600;flex:1}.btn-edit:hover{opacity:.8}
    .btn-delete{background:#ef4444;color:#fff;border:none;padding:.5rem 1rem;border-radius:8px;cursor:pointer;font-weight:600}.btn-delete:hover{opacity:.8}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:2000;display:none;justify-content:center;align-items:center;padding:1rem;overflow-y:auto}
    .modal-overlay.show{display:flex}
    .modal{background:#374151;border-radius:16px;width:100%;max-width:800px;max-height:90vh;overflow-y:auto;padding:2rem;position:relative;margin:auto}
    .modal-close{position:absolute;top:1rem;right:1rem;background:none;border:none;font-size:1.5rem;cursor:pointer;color:#9ca3af}
    .modal h2{color:#f9fafb;margin-bottom:1.5rem}
    .form-group{margin-bottom:1.25rem}
    .form-group label{display:block;margin-bottom:.5rem;font-weight:500;color:#d1d5db;font-size:.875rem}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:.75rem;border:2px solid #4b5563;border-radius:8px;background:#1f2937;color:#f9fafb;font-size:1rem}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#7c3aed}
    .form-group textarea{resize:vertical;min-height:80px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .btn-save{width:100%;background:linear-gradient(135deg,#7c3aed,#4f46e5);color:#fff;border:none;padding:1rem;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;margin-top:1rem}
    .btn-save:hover{opacity:.9}
    .toggle-variants{background:#4b5563;color:#f9fafb;border:none;padding:.75rem 1.5rem;border-radius:8px;cursor:pointer;font-weight:600;margin-bottom:1rem;width:100%}
    .toggle-variants:hover{background:#6b7280}
    .toggle-variants.active{background:#7c3aed}
    .variants-section{display:none;background:#1f2937;padding:1.5rem;border-radius:12px;margin-bottom:1rem}
    .variants-section.show{display:block}
    .variant-item{background:#374151;padding:1rem;border-radius:8px;margin-bottom:1rem;position:relative}
    .variant-item .btn-remove-variant{position:absolute;top:.5rem;right:.5rem;background:#ef4444;color:#fff;border:none;padding:.25rem .5rem;border-radius:4px;cursor:pointer;font-size:.75rem}
    .btn-add-variant{background:#10b981;color:#fff;border:none;padding:.75rem 1.5rem;border-radius:8px;cursor:pointer;font-weight:600;width:100%}
    .btn-add-variant:hover{opacity:.9}
    .variant-badge{display:inline-block;background:#4b5563;padding:.25rem .75rem;border-radius:12px;font-size:.75rem;margin:.25rem}
    @media(max-width:768px){.order-body{grid-template-columns:1fr}.stats{grid-template-columns:1fr 1fr}.form-row{grid-template-columns:1fr}.products-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div id="login-screen" class="login-screen">
    <div class="login-box">
      <div class="login-logo">üîê</div>
      <h2>Area Riservata</h2>
      <p>Inserisci la password</p>
      <form onsubmit="checkPassword(event)">
        <input type="password" id="admin-password" placeholder="Password" autofocus>
        <button type="submit">Accedi ‚Üí</button>
      </form>
      <p id="login-error" class="login-error"></p>
    </div>
  </div>

  <div id="admin-panel" style="display:none">
    <header>
      <div class="logo">üì± TOP PHONE <span>/ Admin</span></div>
      <div class="header-actions"><a href="index.html">‚Üê Sito</a><button class="btn-logout" onclick="logout()">Esci</button></div>
    </header>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('orders')">üì¶ Ordini</button>
      <button class="tab-btn" onclick="switchTab('products')">üì± Prodotti</button>
    </div>

    <div id="tab-orders" class="tab-content active">
      <div class="stats">
        <div class="stat-card pending"><h3>In Attesa</h3><div class="value" id="stat-pending">0</div></div>
        <div class="stat-card paid"><h3>Da Spedire</h3><div class="value" id="stat-paid">0</div></div>
        <div class="stat-card shipped"><h3>Spediti</h3><div class="value" id="stat-shipped">0</div></div>
        <div class="stat-card revenue"><h3>Incasso</h3><div class="value" id="stat-revenue">‚Ç¨0</div></div>
      </div>
      <div class="filters">
        <button class="filter-btn active" onclick="filterOrders('all',this)">Tutti</button>
        <button class="filter-btn" onclick="filterOrders('pending',this)">‚è≥ Attesa</button>
        <button class="filter-btn" onclick="filterOrders('paid',this)">‚úÖ Pagati</button>
        <button class="filter-btn" onclick="filterOrders('shipped',this)">üì¶ Spediti</button>
        <button class="filter-btn" onclick="filterOrders('delivered',this)">üè† Consegnati</button>
      </div>
      <div class="orders" id="orders"><div class="loading">‚è≥ Caricamento...</div></div>
    </div>

    <div id="tab-products" class="tab-content">
      <div class="products-header">
        <h2 style="color:#f9fafb">üì± Gestione Prodotti</h2>
        <button class="btn-add" onclick="openProductModal()">+ Nuovo Prodotto</button>
      </div>
      <div class="products-grid" id="products"><div class="loading">‚è≥ Caricamento...</div></div>
    </div>
  </div>

  <div class="modal-overlay" id="product-modal">
    <div class="modal">
      <button class="modal-close" onclick="closeProductModal()">√ó</button>
      <h2 id="modal-title">‚ûï Nuovo Prodotto</h2>
      <form id="product-form" onsubmit="saveProduct(event)">
        <input type="hidden" id="product-id">
        
        <div class="form-group">
          <label>Nome Prodotto *</label>
          <input type="text" id="product-name" required placeholder="es. Samsung Galaxy A56">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Categoria *</label>
            <select id="product-category" required>
              <option value="">Seleziona brand...</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Rating</label>
            <input type="number" id="product-rating" step="0.1" min="0" max="5" placeholder="4.5">
          </div>
        </div>
        
        <div class="form-group">
          <label>URL Immagine</label>
          <input type="url" id="product-image" placeholder="https://...">
        </div>
        
        <div class="form-group">
          <label>Descrizione</label>
          <textarea id="product-description" placeholder="Descrizione del prodotto..."></textarea>
        </div>

        <button type="button" class="toggle-variants" id="toggle-variants-btn" onclick="toggleVariantsSection()">
          üé® Gestisci Varianti (Colori/Memoria)
        </button>

        <div class="variants-section" id="variants-section">
          <p style="color:#9ca3af;margin-bottom:1rem;font-size:.875rem">
            üí° Aggiungi varianti per gestire colori e memorie diverse.<br>
            Se non usi varianti, inserisci prezzo e stock sotto.
          </p>
          <div id="variants-list"></div>
          <button type="button" class="btn-add-variant" onclick="addVariantField()">+ Aggiungi Variante</button>
        </div>

        <div id="simple-fields">
          <div class="form-row">
            <div class="form-group">
              <label>Prezzo (‚Ç¨) *</label>
              <input type="number" id="product-price" step="0.01" min="0" placeholder="899.00">
            </div>
            
            <div class="form-group">
              <label>Stock *</label>
              <input type="number" id="product-stock" min="0" placeholder="10">
            </div>
          </div>
        </div>
        
        <button type="submit" class="btn-save">üíæ Salva Prodotto</button>
      </form>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://hrjokojbvbmcftmjxihv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhyam9rb2pidmJtY2Z0bWp4aWh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NjY0NzYsImV4cCI6MjA3OTM0MjQ3Nn0.Lk2_VLJbsfQrtDbGgFq9mCNKKdkdyTdCOhktsYIO1Vg';
    const ADMIN_PASSWORD = 'admin123';

    let orders = [], orderItems = {}, currentFilter = 'all';
    let products = [], categories = [];
    let variantCounter = 0;

    function checkSession() { if (sessionStorage.getItem('adminLoggedIn') === 'true') showAdminPanel(); }
    function checkPassword(e) {
      e.preventDefault();
      if (document.getElementById('admin-password').value === ADMIN_PASSWORD) { sessionStorage.setItem('adminLoggedIn', 'true'); showAdminPanel(); }
      else { document.getElementById('login-error').textContent = '‚ùå Password errata'; document.getElementById('admin-password').value = ''; }
    }
    function showAdminPanel() { document.getElementById('login-screen').style.display = 'none'; document.getElementById('admin-panel').style.display = 'block'; loadOrders(); loadProducts(); loadCategories(); }
    function logout() { sessionStorage.removeItem('adminLoggedIn'); location.reload(); }

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById(`tab-${tab}`).classList.add('active');
    }

    async function loadOrders() {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/orders?select=*&order=created_at.desc`, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
        orders = await res.json();
        for (const o of orders) {
          const r = await fetch(`${SUPABASE_URL}/rest/v1/order_items?select=*,products(name,price)&order_id=eq.${o.id}`, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
          orderItems[o.id] = await r.json();
        }
        updateStats(); renderOrders();
      } catch (e) { document.getElementById('orders').innerHTML = '<div class="empty">‚ùå Errore</div>'; }
    }

    function updateStats() {
      document.getElementById('stat-pending').textContent = orders.filter(o => o.status === 'pending').length;
      document.getElementById('stat-paid').textContent = orders.filter(o => o.status === 'paid').length;
      document.getElementById('stat-shipped').textContent = orders.filter(o => o.status === 'shipped' || o.status === 'delivered').length;
      document.getElementById('stat-revenue').textContent = `‚Ç¨${orders.filter(o => o.status !== 'pending').reduce((s, o) => s + parseFloat(o.total || 0), 0).toFixed(2)}`;
    }

    function filterOrders(s, btn) { currentFilter = s; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderOrders(); }

    function renderOrders() {
      const f = currentFilter === 'all' ? orders : orders.filter(o => o.status === currentFilter);
      if (!f.length) { document.getElementById('orders').innerHTML = '<div class="empty">üî≠ Nessun ordine</div>'; return; }
      document.getElementById('orders').innerHTML = f.map(o => {
        const items = orderItems[o.id] || [];
        const date = new Date(o.created_at).toLocaleDateString('it-IT', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        const labels = {pending:'‚è≥ Attesa',paid:'‚úÖ Pagato',shipped:'üì¶ Spedito',delivered:'üè† Consegnato'};
        return `<div class="order-card">
          <div class="order-header"><div><span class="order-id">#${o.id}</span><span class="order-date"> - ${date}</span></div><span class="order-status status-${o.status}">${labels[o.status]||o.status}</span></div>
          ${o.status==='pending'?'<div class="payment-warning">‚ö†Ô∏è NON SPEDIRE - Pagamento non confermato</div>':''}
          <div class="order-body">
            <div class="order-section"><h4>üë§ Cliente</h4><p><strong>${o.customer_name||'N/D'}</strong></p><p>${o.customer_email||''}</p><p>${o.customer_phone||''}</p><h4 style="margin-top:1rem">üìç Indirizzo</h4><p>${o.customer_address||'N/D'}</p>${o.notes?`<p><em>${o.notes}</em></p>`:''}</div>
            <div class="order-section"><h4>üì¶ Prodotti</h4><div class="order-items">${items.map(i=>`<div class="order-item ${i.shipped?'item-shipped':''}"><label class="item-check"><input type="checkbox" ${i.shipped?'checked':''} onchange="toggleItem(${o.id},${i.id},this.checked)" ${o.status==='pending'?'disabled':''}><span>${i.products?.name||'Prodotto'} √ó ${i.quantity}</span></label><span>‚Ç¨${(parseFloat(i.price)*i.quantity).toFixed(2)}</span></div>`).join('')}</div><div class="order-total">Totale: ‚Ç¨${parseFloat(o.total).toFixed(2)}</div></div>
          </div>
          <div class="order-actions">
            <button class="btn btn-paid" onclick="updateStatus(${o.id},'paid')" ${o.status!=='pending'?'disabled':''}>‚úÖ Pagato</button>
            <button class="btn btn-shipped" onclick="updateStatus(${o.id},'shipped')" ${o.status!=='paid'?'disabled':''}>üì¶ Spedito</button>
            <button class="btn btn-delivered" onclick="updateStatus(${o.id},'delivered')" ${o.status!=='shipped'?'disabled':''}>üè† Consegnato</button>
          </div>
        </div>`;
      }).join('');
    }

    async function updateStatus(id, s) {
      if (!confirm(`Cambiare stato ordine #${id}?`)) return;
      const order = orders.find(o => o.id === id);
      await fetch(`${SUPABASE_URL}/rest/v1/orders?id=eq.${id}`, { method: 'PATCH', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ status: s }) });
      if (s === 'shipped' && order?.customer_email) await sendShippedEmail(order);
      order.status = s; updateStats(); renderOrders();
    }

    async function sendShippedEmail(order) {
      const email = order.customer_email;
      const subject = `Il tuo ordine Top Phone #${order.id} √® stato spedito! üì¶`;
      const body = `Ciao ${order.customer_name},%0A%0AIl tuo ordine Top Phone #${order.id} √® stato spedito!%0A%0AIndirizzo di consegna:%0A${order.customer_address}%0A%0ATotale: ‚Ç¨${parseFloat(order.total).toFixed(2)}%0A%0AGrazie per aver scelto Top Phone!%0A%0AIl team Top Phone üì±`;
      window.open(`mailto:${email}?subject=${encodeURIComponent(subject)}&body=${body}`, '_blank');
      alert(`üìß Email pronta per ${email}!\nClicca "Invia" nel tuo client email.`);
    }

    async function toggleItem(oid, iid, shipped) {
      await fetch(`${SUPABASE_URL}/rest/v1/order_items?id=eq.${iid}`, { method: 'PATCH', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ shipped }) });
      const i = orderItems[oid]?.find(x => x.id === iid); if (i) i.shipped = shipped; renderOrders();
    }

    async function loadCategories() {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/categories?select=*`, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
        categories = await res.json();
        const sel = document.getElementById('product-category');
        sel.innerHTML = '<option value="">Seleziona brand...</option>' + categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      } catch (e) { console.error(e); }
    }

    async function loadProducts() {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/products?select=*,categories(name)&order=created_at.desc`, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } });
        products = await res.json();
        renderProducts();
      } catch (e) { document.getElementById('products').innerHTML = '<div class="empty">‚ùå Errore</div>'; }
    }

    function getTotalStock(p) {
      if (p.variants && p.variants.length > 0) return p.variants.reduce((s, v) => s + (v.stock || 0), 0);
      return p.stock || 0;
    }

    function getPriceRange(p) {
      if (p.variants && p.variants.length > 0) {
        const prices = p.variants.map(v => v.price);
        const min = Math.min(...prices);
        const max = Math.max(...prices);
        if (min === max) return `‚Ç¨${min.toFixed(2)}`;
        return `‚Ç¨${min.toFixed(2)} - ‚Ç¨${max.toFixed(2)}`;
      }
      return `‚Ç¨${parseFloat(p.price || 0).toFixed(2)}`;
    }

    function renderProducts() {
      if (!products.length) { document.getElementById('products').innerHTML = '<div class="empty">üì± Nessun prodotto. Aggiungi il primo!</div>'; return; }
      document.getElementById('products').innerHTML = products.map(p => {
        const hasVariants = p.variants && p.variants.length > 0;
        const variantsInfo = hasVariants ? `<div style="margin-top:.5rem">${p.variants.map(v => `<span class="variant-badge">${v.color} ${v.storage}</span>`).join('')}</div>` : '';
        return `
        <div class="product-card">
          <div class="product-img" style="${p.image_url?`background-image:url('${p.image_url}')`:''}">${!p.image_url?'üì±':''}</div>
          <div class="product-body">
            <div class="product-cat">${p.categories?.name||'N/D'}</div>
            <div class="product-name">${p.name}</div>
            <div class="product-price">${getPriceRange(p)}</div>
            <div class="product-stock">Stock: ${getTotalStock(p)} ${p.rating?`‚Ä¢ ‚≠ê ${p.rating}`:''}</div>
            ${variantsInfo}
            <div class="product-actions">
              <button class="btn-edit" onclick="editProduct(${p.id})">‚úèÔ∏è Modifica</button>
              <button class="btn-delete" onclick="deleteProduct(${p.id})">üóëÔ∏è</button>
            </div>
          </div>
        </div>
      `}).join('');
    }

    function toggleVariantsSection() {
      const section = document.getElementById('variants-section');
      const btn = document.getElementById('toggle-variants-btn');
      const simpleFields = document.getElementById('simple-fields');
      section.classList.toggle('show');
      btn.classList.toggle('active');
      simpleFields.style.display = section.classList.contains('show') ? 'none' : 'block';
    }

    function addVariantField(variant = null) {
      const id = variant ? variant.id || variantCounter++ : variantCounter++;
      const html = `
        <div class="variant-item" id="variant-${id}">
          <button type="button" class="btn-remove-variant" onclick="removeVariant(${id})">√ó</button>
          <div class="form-row">
            <div class="form-group">
              <label>Colore *</label>
              <input type="text" class="variant-color" placeholder="es. Nero" value="${variant?.color||''}" required>
            </div>
            <div class="form-group">
              <label>Memoria *</label>
              <input type="text" class="variant-storage" placeholder="es. 128GB" value="${variant?.storage||''}" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Prezzo (‚Ç¨) *</label>
              <input type="number" class="variant-price" step="0.01" min="0" placeholder="299.00" value="${variant?.price||''}" required>
            </div>
            <div class="form-group">
              <label>Stock *</label>
              <input type="number" class="variant-stock" min="0" placeholder="10" value="${variant?.stock||''}" required>
            </div>
          </div>
          <div class="form-group">
            <label>SKU (opzionale)</label>
            <input type="text" class="variant-sku" placeholder="es. A56-BLK-128" value="${variant?.sku||''}">
          </div>
        </div>
      `;
      document.getElementById('variants-list').insertAdjacentHTML('beforeend', html);
    }

    function removeVariant(id) {
      document.getElementById(`variant-${id}`)?.remove();
    }

    function getVariantsFromForm() {
      const variantItems = document.querySelectorAll('.variant-item');
      if (variantItems.length === 0) return [];
      const variants = [];
      variantItems.forEach(item => {
        const color = item.querySelector('.variant-color').value.trim();
        const storage = item.querySelector('.variant-storage').value.trim();
        const price = parseFloat(item.querySelector('.variant-price').value);
        const stock = parseInt(item.querySelector('.variant-stock').value);
        const sku = item.querySelector('.variant-sku').value.trim();
        if (color && storage && !isNaN(price) && !isNaN(stock)) {
          variants.push({ color, storage, price, stock, sku: sku || null });
        }
      });
      return variants;
    }

    function openProductModal(id = null) {
      document.getElementById('product-modal').classList.add('show');
      document.getElementById('product-form').reset();
      document.getElementById('product-id').value = '';
      document.getElementById('modal-title').textContent = '‚ûï Nuovo Prodotto';
      document.getElementById('variants-list').innerHTML = '';
      document.getElementById('variants-section').classList.remove('show');
      document.getElementById('toggle-variants-btn').classList.remove('active');
      document.getElementById('simple-fields').style.display = 'block';
      variantCounter = 0;
    }

    function closeProductModal() {
      document.getElementById('product-modal').classList.remove('show');
    }

    function editProduct(id) {
      const p = products.find(x => x.id === id);
      if (!p) return;
      document.getElementById('modal-title').textContent = '‚úèÔ∏è Modifica Prodotto';
      document.getElementById('product-id').value = p.id;
      document.getElementById('product-name').value = p.name;
      document.getElementById('product-category').value = p.category_id;
      document.getElementById('product-rating').value = p.rating || '';
      document.getElementById('product-image').value = p.image_url || '';
      document.getElementById('product-description').value = p.description || '';
      
      document.getElementById('variants-list').innerHTML = '';
      if (p.variants && p.variants.length > 0) {
        document.getElementById('variants-section').classList.add('show');
        document.getElementById('toggle-variants-btn').classList.add('active');
        document.getElementById('simple-fields').style.display = 'none';
        p.variants.forEach(v => addVariantField(v));
      } else {
        document.getElementById('product-price').value = parseFloat(p.price || 0);
        document.getElementById('product-stock').value = p.stock || 0;
      }
      
      document.getElementById('product-modal').classList.add('show');
    }

    async function saveProduct(e) {
      e.preventDefault();
      const id = document.getElementById('product-id').value;
      const variants = getVariantsFromForm();
      const useVariants = variants.length > 0;
      
      const data = {
        name: document.getElementById('product-name').value,
        category_id: parseInt(document.getElementById('product-category').value),
        rating: parseFloat(document.getElementById('product-rating').value) || null,
        image_url: document.getElementById('product-image').value || null,
        description: document.getElementById('product-description').value || null,
        variants: useVariants ? variants : []
      };

      if (!useVariants) {
        data.price = parseFloat(document.getElementById('product-price').value);
        data.stock = parseInt(document.getElementById('product-stock').value);
      } else {
        data.price = 1;
        data.stock = 0;
      }

      try {
        if (id) {
          await fetch(`${SUPABASE_URL}/rest/v1/products?id=eq.${id}`, {
            method: 'PATCH',
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          alert('‚úÖ Prodotto aggiornato!');
        } else {
          await fetch(`${SUPABASE_URL}/rest/v1/products`, {
            method: 'POST',
            headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify(data)
          });
          alert('‚úÖ Prodotto aggiunto!');
        }
        closeProductModal();
        await loadProducts();
      } catch (e) {
        alert('‚ùå Errore: ' + e.message);
      }
    }

    async function deleteProduct(id) {
      if (!confirm('Eliminare questo prodotto?')) return;
      try {
        await fetch(`${SUPABASE_URL}/rest/v1/products?id=eq.${id}`, {
          method: 'DELETE',
          headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
        });
        // Rimuovi dall'array products
        products = products.filter(p => p.id !== id);
        alert('‚úÖ Prodotto eliminato!');
        renderProducts();
      } catch (e) {
        alert('‚ùå Errore: ' + e.message);
      }
    }

    checkSession();
  </script>
</body>
</html>
