<!DOCTYPE html>
<html lang="it">
const params = new URLSearchParams(window.location.search);
const sessionId = params.get('session_id');

if (!sessionId) {
  showError('Accesso non autorizzato');
  return;
}
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verifica Pagamento...</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(135deg, #7c3aed, #4f46e5); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; }
    .container { background: white; border-radius: 20px; padding: 3rem; max-width: 500px; width: 100%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .icon { font-size: 5rem; margin-bottom: 1rem; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    h1 { color: #1f2937; margin-bottom: 0.5rem; }
    .subtitle { color: #6b7280; margin-bottom: 2rem; }
    .order-box { background: #f9fafb; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; text-align: left; }
    .order-box h3 { color: #1f2937; margin-bottom: 1rem; font-size: 1rem; }
    .order-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb; }
    .order-row:last-child { border-bottom: none; font-weight: 700; color: #7c3aed; }
    .btn { display: inline-block; background: linear-gradient(135deg, #7c3aed, #4f46e5); color: white; text-decoration: none; padding: 1rem 2rem; border-radius: 30px; font-weight: 700; transition: opacity 0.3s; }
    .btn:hover { opacity: 0.9; }
    .note { color: #6b7280; font-size: 0.875rem; margin-top: 1.5rem; }
    .error { color: #ef4444; }
    .success { color: #10b981; }
  </style>
</head>
<body>
  <div class="container" id="content">
    <div class="icon">‚è≥</div>
    <h1>Verifica pagamento...</h1>
    <p class="subtitle">Attendere prego</p>
  </div>

  <script>
    const SUPABASE_URL = 'https://hrjokojbvbmcftmjxihv.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhyam9rb2pidmJtY2Z0bWp4aWh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NjY0NzYsImV4cCI6MjA3OTM0MjQ3Nn0.Lk2_VLJbsfQrtDbGgFq9mCNKKdkdyTdCOhktsYIO1Vg';

    async function verifyPayment() {
      const params = new URLSearchParams(window.location.search);
      const sessionId = params.get('session_id');

      if (!sessionId) {
        showError('Accesso non autorizzato');
        return;
      }

      try {
        // Verifica sessione tramite Edge Function
        const verifyRes = await fetch(`${SUPABASE_URL}/functions/v1/verify-payment`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_KEY}`
          },
          body: JSON.stringify({ sessionId })
        });

        if (!verifyRes.ok) {
          throw new Error('Pagamento non verificato');
        }

        const { order, paid } = await verifyRes.json();

        if (!paid) {
          showError('Pagamento non completato');
          return;
        }

        // Mostra conferma
        showSuccess(order);

        // Pulisci localStorage
        localStorage.removeItem('cart');

      } catch (e) {
        console.error(e);
        showError(e.message || 'Errore verifica pagamento');
      }
    }

    function showSuccess(order) {
      document.getElementById('content').innerHTML = `
        <div class="icon success">‚úÖ</div>
        <h1 class="success">Ordine Confermato!</h1>
        <p class="subtitle">Grazie per il tuo acquisto</p>
        
        <div class="order-box">
          <h3>üì¶ Riepilogo Ordine</h3>
          <div class="order-row">
            <span>Numero ordine:</span>
            <span>#${order.id}</span>
          </div>
          <div class="order-row">
            <span>Totale pagato:</span>
            <span>‚Ç¨${parseFloat(order.total).toFixed(2)}</span>
          </div>
        </div>
        
        <a href="index.html" class="btn">Continua lo Shopping ‚Üí</a>
        
        <p class="note">üìß Riceverai un'email di conferma a ${order.customer_email}</p>
      `;
    }

    function showError(message) {
      document.getElementById('content').innerHTML = `
        <div class="icon error">‚ùå</div>
        <h1 class="error">Errore</h1>
        <p class="subtitle">${message}</p>
        <a href="index.html" class="btn">Torna al sito</a>
      `;
    }

    verifyPayment();
  </script>
</body>
</html>